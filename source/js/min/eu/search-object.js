define(["jquery","media_controller"],function(a){function b(){window.location.href.indexOf("ellipsis")>-1&&a(".mlt-title a").each(function(){for(;a(this).outerHeight()>a(this).parent().height();)a(this).text(function(a,b){return b.replace(/\W*\s(\S)*$/,"...")})})}function c(){if(window.location.href.indexOf("mlt-stretch")>-1){var b=".mlt .mlt-item, .mlt-title";console.log("removed max-width from selector "+b),a(b).css("max-width","none")}}function d(){var b=function(a){"function"==typeof jQuery&&a instanceof jQuery&&(a=a[0]);var b=a.getBoundingClientRect();return b.top>=0&&b.left>=0&&b.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&b.right<=(window.innerWidth||document.documentElement.clientWidth)};a(window).on("scroll",function(){a(".scroll-trigger[enabled=true]").each(function(){if(b(a(this))){a(this).attr("enabled",!1);var c=a(this).data("fire-on-open"),d=a(this).data("fire-on-open-params");a(window).trigger(c,d)}})}),a(document).ready(function(){a(".scroll-trigger").each(function(){if(b(this)){a(this).attr("enabled",!1);var c=a(this).data("fire-on-open"),d=a(this).data("fire-on-open-params");a(window).trigger(c,d),console.log("evt: "+c+"  "+d)}})})}function e(){a(".js-showhide").on("click",function(b){var c=a(this),d=a(this).parent();d.find(".js-showhide-panel").toggleClass("is-jshidden"),d.toggleClass("is-expanded"),c.text()===c.data("text-swap")?c.text(c.data("text-original")):(c.data("text-original",c.text()),c.text(c.data("text-swap"))),b.preventDefault()})}function f(b){var c=function(b,c,d){console.log("initLeaflet:\n	"+JSON.stringify(b)+"\n	"+JSON.stringify(c));var e="map",f="map-info",g=a("#map-place-name").text();require([js_path+"application-map.js"],function(){a("#"+e).after('<div id="'+f+'"></div>');var h='Tiles &copy; <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png" alt="mapquest logo"/>',i=new L.TileLayer("http://otile{s}.mqcdn.com/tiles/1.0.0/{type}/{z}/{x}/{y}.png",{minZoom:4,maxZoom:18,attribution:h,subdomains:"1234",type:"osm"}),j=L.map(e,{center:new L.LatLng(c[0],b[0]),zoomControl:!0,zoom:8});L.Icon.Default.imagePath=js_path+"css/map/images",j.addLayer(i),j.invalidateSize();for(var k=[],l=0;l<Math.min(c.length,b.length);l++)L.marker([c[l],b[l]]).addTo(j),k.push(c[l]+"&deg; "+(c[l]>0?d.n:d.s)+", "+b[l]+"&deg; "+(b[l]>0?d.e:d.w));g=g?g.toUpperCase()+" ":"",a("#"+f).html(g+(k.length?" "+k.join(", "):"")),a("head").append('<link rel="stylesheet" href="'+js_path+'css/map/application-map.css" type="text/css"/>')})},d=(b.latitude+"").split(/,*\s+/g),e=(b.longitude+"").split(/,*\s+/g);if(d&&e){for(var f=0;f<d.length;f++)d[f]=d[f].replace(/,/g,".").indexOf(".")>-1?d[f]:d[f]+".00";for(var f=0;f<e.length;f++)e[f]+e[f].replace(/,/g,".").indexOf(".")>-1?e[f]:e[f]+".00";for(var g=[],h=[],f=0;f<Math.min(d.length,e.length);f++)d[f]&&e[f]&&[d[f]+"",e[f]+""].join(",").match(/^\s*-?\d+\.\d+\,\s?-?\d+\.\d+\s*$/)?(g.push(e[f]),h.push(d[f])):console.log("Map data error: invalid coordinate pair:\n	"+g[f]+"\n	"+h[f]);g.length&&h.length?c(g,h,b.labels):console.log("Map data missing")}}function g(){"undefined"!=typeof b&&b(),"undefined"!=typeof c&&c(),e(),a(window).bind("showMLT",function(a,b){h()}),a(window).bind("showMap",function(a,b){f(b)}),d(),a(".media-viewer").trigger("media_init")}var h=function(){require(["eu_carousel"],function(b){var c=a(".js-mlt"),d=[];reg=/(?:\(['|"]?)(.*?)(?:['|"]?\))/,c.find("a.link").each(function(b,c){c=a(c),d[d.length]={thumb:reg.exec(c.closest(".mlt-img-div").css("background-image"))[1],title:c.closest(".mlt-img-div").next(".mlt-title").find("a")[0].innerHTML,link:c.attr("href"),linkTarget:"_self"}}),new b(c,d)})};g()});
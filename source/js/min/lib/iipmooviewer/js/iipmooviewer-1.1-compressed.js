var iip,TargetDrag=new Class({Extends:Drag,initialize:function(){var a=Array.link(arguments,{options:Object.type,element:$defined});this.element=$(a.element),this.document=this.element.getDocument(),this.setOptions(a.options||{});var b=$type(this.options.handle);this.handles="array"==b||"collection"==b?$$(this.options.handle):$(this.options.handle)||this.element,this.mouse={now:{},pos:{}},this.value={start:{},now:{}},this.selection=Browser.Engine.trident?"selectstart":"mousedown",this.bound={start:this.start.bind(this),check:this.check.bind(this),drag:this.drag.bind(this),stop:this.stop.bind(this),cancel:this.cancel.bind(this),eventStop:$lambda(!1)},this.attach(),Browser.Engine.trident&&(this.handles.ondragstart=function(){return!1})},drag:function(a){this.options.preventDefault&&a.preventDefault(),this.mouse.now=a.page;for(var b in this.options.modifiers)this.options.modifiers[b]&&(this.value.now[b]=this.mouse.now[b]-this.mouse.pos[b],"x"==b&&(iip.rgn_x-this.value.now[b]<0&&(this.value.now[b]=iip.rgn_x,this.out=!0),iip.wid>iip.rgn_w?iip.rgn_x-this.value.now[b]>iip.wid-iip.rgn_w&&(this.value.now[b]=-(iip.wid-iip.rgn_w-iip.rgn_x),this.out=!0):(this.value.now[b]=0,this.out=!0)),"y"==b&&(iip.rgn_y-this.value.now[b]<0&&(this.value.now[b]=iip.rgn_y,this.out=!0),iip.hei>iip.rgn_h?iip.rgn_y-this.value.now[b]>iip.hei-iip.rgn_h&&(this.value.now[b]=-(iip.hei-iip.rgn_h-iip.rgn_y),this.out=!0):(this.value.now[b]=0,this.out=!0)),this.options.grid[b]&&(this.value.now[b]-=this.value.now[b]%this.options.grid[b]),this.options.style?this.element.setStyle(this.options.modifiers[b],this.value.now[b]+this.options.unit):this.element[this.options.modifiers[b]]=this.value.now[b]);this.fireEvent("drag",this.element)}}),IIP=new Class({initialize:function(a,b){if(this.source=a||alert("No element ID given to IIP constructor"),this.server=b.server||"/fcgi-bin/iipsrv.fcgi",this.render=b.render||"random",this.images=new Array(b.image.length),b.image||alert("Image location not set in IIP constructor options"),"array"==$type(b.image))for(i=0;i<b.image.length;i++)this.images[i]={src:b.image[i],sds:"0,90"};else this.images=[{src:b.image,sds:"0,90"}];this.credit=b.credit||null,this.scale=b.scale||null,0==b.zoom?this.initialZoom=0:this.initialZoom=b.zoom||1,this.showNavButtons=!0,0==b.showNavButtons&&(this.showNavButtons=!1),this.targetclick=b.targetclick||null,this.max_width=0,this.max_height=0,this.min_x=0,this.min_y=0,this.sds="0,90",this.contrast=1,this.opacity=0,this.wid=0,this.hei=0,this.rgn_x=0,this.rgn_y=0,this.rgn_w=this.wid,this.rgn_h=this.wid,this.xfit=0,this.yfit=0,this.navpos=[0,0],this.tileSize=[0,0],this.num_resolutions=0,this.res,this.refresher=null,this.nTilesLoaded=0,this.nTilesToLoad=0,window.addEvent("domready",function(){this.load()}.bind(this))},requestImages:function(){this.refresher&&($clear(this.refresher),this.refresher=null),$("target").setStyle("cursor","wait"),this.loadGrid()},loadGrid:function(){$(this.source).getPosition();$("target").getChildren().each(function(a){a.fireEvent("abort"),a.destroy()}),$("target").setStyles({left:0,top:0});var a=Math.floor(this.rgn_x/this.tileSize[0]),b=Math.floor(this.rgn_y/this.tileSize[1]),c=this.rgn_w;this.wid<this.rgn_w&&(c=this.wid);var d=Math.ceil((c+this.rgn_x)/this.tileSize[0]-1);c=this.rgn_h,this.hei<this.rgn_h&&(c=this.hei);var e=Math.ceil((c+this.rgn_y)/this.tileSize[1]-1),f=Math.ceil(this.wid/this.tileSize[0]),g=(Math.ceil(this.hei/this.tileSize[1]),Math.floor(this.rgn_x%this.tileSize[0]));this.wid<this.rgn_w&&(g-=(this.rgn_w-this.wid)/2);var h=Math.floor(this.rgn_y%this.tileSize[1]);this.hei<this.rgn_h&&(h-=(this.rgn_h-this.hei)/2);var i,j,k,l,m;l=0,m=0;var n=a+Math.round((d-a)/2),o=b+Math.round((e-b)/2),p=new Array((d-a)*(d-a)),q=0;for(k=b;e>=k;k++)for(j=a;d>=j;j++)p[q]={},"spiral"==this.render?p[q].n=Math.abs(o-k)*Math.abs(o-k)+Math.abs(n-j)*Math.abs(n-j):p[q].n=Math.random(),p[q].x=j,p[q].y=k,q++;this.nTilesLoaded=0,this.nTilesToLoad=q*this.images.length,p.sort(function(a,b){return a.n-b.n});for(var r=0;q>r;r++){var j=p[r].x,k=p[r].y;l=j+k*f;var m;for(m=0;m<this.images.length;m++){i=new Element("img",{"class":"layer"+m,styles:{left:(j-a)*this.tileSize[0]-g,top:(k-b)*this.tileSize[1]-h},events:{load:function(){this.nTilesLoaded++,this.refreshLoadBar()}.bind(this),error:function(){this.src=this.src}}});var s=this.server+"?FIF="+this.images[m].src+"&cnt="+this.contrast+"&sds="+this.images[m].sds+"&jtl="+this.res+","+l;i.set("src",s),i.injectInside("target")}}if(this.images.length>1){var t="img.layer"+(m-1);$$(t).set("opacity",this.opacity)}},refresh:function(){var a=0;$("target").getChildren().each(function(b){(0==b.width||0==b.height)&&(b.src=b.src,a=1)}),0==a&&($clear(this.refresher),this.refresher=null)},key:function(a){var b=100;switch(a.code){case 37:this.scrollTo(-b,0);break;case 38:this.scrollTo(0,-b);break;case 39:this.scrollTo(b,0);break;case 40:this.scrollTo(0,b);break;case 107:a.control||this.zoomIn();break;case 109:a.control||this.zoomOut()}},scrollNavigation:function(a){var b=0,c=0,d=$("zone").getSize(),e=d.x,f=d.y;if(a.event){var g=$("navwin").getPosition();b=a.event.clientX-g.x-e/2,c=a.event.clientY-g.y-f/2}else if(b=a.offsetLeft,c=a.offsetTop-10,Math.abs(b-this.navpos[0])<3&&Math.abs(c-this.navpos[1])<3)return;b>this.min_x-e&&(b=this.min_x-e),c>this.min_y-f&&(c=this.min_y-f),0>b&&(b=0),0>c&&(c=0),this.rgn_x=Math.round(b*this.wid/this.min_x),this.rgn_y=Math.round(c*this.hei/this.min_y),this.requestImages(),a.event&&this.positionZone()},scroll:function(){var a=-$("target").offsetLeft,b=-$("target").offsetTop;this.scrollTo(a,b)},checkBounds:function(a,b){var c=this.rgn_x+a,d=this.rgn_y+b;c>this.wid-this.rgn_w&&(c=this.wid-this.rgn_w),d>this.hei-this.rgn_h&&(d=this.hei-this.rgn_h),0>c&&(c=0),0>d&&(d=0),this.rgn_x=c,this.rgn_y=d},scrollTo:function(a,b){if(a||b){if(Math.abs(a)<3&&Math.abs(b)<3)return;this.checkBounds(a,b),this.requestImages(),this.positionZone()}},zoom:function(a){var b=new Event(a);b.wheel?b.wheel>0?this.zoomIn():b.wheel<0&&this.zoomOut():b.shift?this.zoomOut():this.zoomIn()},zoomIn:function(){if(this.wid<=this.max_width/2&&this.hei<=this.max_height/2){this.res++,this.wid=this.max_width,this.hei=this.max_height;for(var a=this.res;a<this.num_resolutions-1;a++)this.wid=Math.floor(this.wid/2),this.hei=Math.floor(this.hei/2);1==this.xfit?this.rgn_x=this.wid/2-this.rgn_w/2:this.wid>this.rgn_w&&(this.rgn_x=2*this.rgn_x+this.rgn_w/2),this.rgn_x>this.wid&&(this.rgn_x=this.wid-this.rgn_w),this.rgn_x<0&&(this.rgn_x=0),1==this.yfit?this.rgn_y=this.hei/2-this.rgn_h/2:this.hei>this.rgn_h&&(this.rgn_y=2*this.rgn_y+this.rgn_h/2),this.rgn_y>this.hei&&(this.rgn_y=this.hei-this.rgn_h),this.rgn_y<0&&(this.rgn_y=0),this.requestImages(),this.positionZone(),this.scale&&this.setScale()}},zoomOut:function(){if(this.wid>this.rgn_w||this.hei>this.rgn_h){this.res--,this.wid=this.max_width,this.hei=this.max_height;for(var a=this.res;a<this.num_resolutions-1;a++)this.wid=Math.floor(this.wid/2),this.hei=Math.floor(this.hei/2);this.rgn_x=this.rgn_x/2-this.rgn_w/4,this.rgn_x+this.rgn_w>this.wid&&(this.rgn_x=this.wid-this.rgn_w),this.rgn_x<0?(this.xfit=1,this.rgn_x=0):this.xfit=0,this.rgn_y=this.rgn_y/2-this.rgn_h/4,this.rgn_y+this.rgn_h>this.hei&&(this.rgn_y=this.hei-this.rgn_h),this.rgn_y<0?(this.yfit=1,this.rgn_y=0):this.yfit=0,this.requestImages(),this.positionZone(),this.scale&&this.setScale()}},calculateMinSizes:function(){var a=this.max_width,b=this.max_height,c=100,d=$(this.source).getSize(),e=d.x,f=d.y;c=e>f?a>2*b?e/2:e/4:f/4;for(var g=this.res;a>c&&(a=parseInt(a/2),b=parseInt(b/2),1!=--g););for(this.min_x=a,this.min_y=b,a=this.max_width,b=this.max_height;a>e&&b>f;)a=parseInt(a/2),b=parseInt(b/2),this.res--;this.wid=a,this.hei=b,this.res--},createWindows:function(){var a=$(this.source).getSize(),b=a.x,c=a.y;this.calculateMinSizes(),this.createNavigationWindow();var d=new Element("div",{id:"target",morph:{transition:Fx.Transitions.Quad.easeInOut,onComplete:this.requestImages.bind(this)}});new TargetDrag(d,{onComplete:this.scroll.bind(this)}),d.injectInside(this.source),d.addEvent("mousewheel",this.zoom.bind(this)),d.addEvent("dblclick",this.zoom.bind(this)),this.targetclick&&d.addEvent("click",this.targetclick.bindWithEvent(this)),this.rgn_w=b,this.rgn_h=c,this.reCenter(),window.addEvent("resize",function(){window.location=window.location}),document.addEvent("keydown",this.key.bindWithEvent(this)),new Element("a",{id:"logo"}).injectInside(this.source),new Element("img",{src:"images/help.png",id:"info",styles:{opacity:.8}}).injectInside("logo"),new Tips("#info, #toolbar",{className:"tip",onShow:function(a){a.setStyle("opacity",0),a.fade(.7)},onHide:function(a){a.fade(0)}}),$("info").store("tip:text",'<h2>Help</h2><ul><li>To navigate within image:<ul><li>drag image within main window or</li><li>drag zone within the navigation window</li><li>click an area within navigation window</li></ul><li>To zoom in:<ul><li>double click with the mouse or</li><li>use the mouse scroll wheel or</li><li>or simply press the "+" key</li></ul><li>To zoom out:<ul><li>shift double click with the mouse or</li><li>use the mouse wheel or</li><li>press the "-" key</li></ul></li><li>To move the navigation window:<ul><li>drag navigation window toolbar</li></ul><li>To show / hide navigation buttons:</li><ul><li>double click navigation window toolbar</li></ul></ul><img style="vertical-align:middle" src="images/iip-favicon.gif"/> IIPImage Scientific Image Visualization<br/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;http://iipimage.sf.net'),Browser.Engine.trident5&&$("info").setStyle("filter",'progid:DXImageTransform.Microsoft.AlphaImageLoader(enabled=true,src="images/help.png",sizingMethod=scale)'),this.credit&&new Element("div",{id:"credit",html:this.credit}).injectInside(this.source),this.scale&&new Element("div",{id:"scale"}).injectInside(this.source);for(var e=0;e<this.initialZoom;e++)this.zoomIn();this.zoomOut(),this.requestImages(),this.positionZone()},createNavigationWindow:function(){var a=new Element("div",{id:"navcontainer",styles:{width:this.min_x,height:10}}),b=new Element("div",{id:"toolbar",styles:{width:this.min_x},events:{dblclick:function(){$("navbuttons").slide("toggle")}}});b.store("tip:text","* Drag to move<br/>* Double Click to show/hide navigation buttons"),b.injectInside(a);var c=new Element("div",{id:"navwin",styles:{width:this.min_x,height:this.min_y}});c.injectInside(a);var d=new Element("img",{id:"navigation",src:this.server+"?FIF="+this.images[0].src+"&SDS="+this.images[0].sds+"&CNT=1.0&WID="+this.min_x+"&QLT=99&CVT=jpeg"});d.injectInside(c);var e=new Element("div",{id:"zone",styles:{width:this.min_x/2,height:this.min_y/2,opacity:.4},morph:{duration:500,transition:Fx.Transitions.Quad.easeInOut}});e.injectInside(c);var f=new Element("div",{id:"loadBarContainer",html:'<div id="loadBar"></div>',styles:{width:this.min_x-2},tween:{duration:1e3,transition:Fx.Transitions.Sine.easeOut,link:"cancel"}}),g=new Element("div",{id:"navbuttons",html:'<img id="zoomIn" src="images/zoomIn.png"/><img id="zoomOut" src="images/zoomOut.png"/>'});g.injectInside(a),g.set("slide",{duration:300,transition:Fx.Transitions.Quad.easeInOut,mode:"vertical"}),f.injectInside(a),a.injectInside(this.source),0==this.showNavButtons&&g.slide("out"),Browser.Engine.trident&&$$("div#navbuttons, div#navbuttons img").setStyle("opacity",.75),a.makeDraggable({container:this.source,handle:b}),$("zoomIn").addEvent("click",this.zoomIn.bindWithEvent(this)),$("zoomOut").addEvent("click",this.zoomOut.bindWithEvent(this)),$("zone").makeDraggable({container:"navwin",onStart:function(){this.navpos=[$("zone").offsetLeft,$("zone").offsetTop-10]}.bind(this),onComplete:this.scrollNavigation.bindWithEvent(this)}),$("navigation").addEvent("click",this.scrollNavigation.bindWithEvent(this)),$("navigation").addEvent("mousewheel",this.zoom.bindWithEvent(this)),$("zone").addEvent("mousewheel",this.zoom.bindWithEvent(this)),$("zone").addEvent("dblclick",this.zoom.bindWithEvent(this))},refreshLoadBar:function(){var a=this.nTilesLoaded/this.nTilesToLoad*this.min_x;$("loadBar").setStyle("width",a),$("loadBar").set("html","loading&nbsp;:&nbsp;"+Math.round(this.nTilesLoaded/this.nTilesToLoad*100)+"%"),.85!=$("loadBarContainer").style.opacity&&$("loadBarContainer").setStyle("opacity",.85),this.nTilesLoaded==this.nTilesToLoad&&($("target").setStyle("cursor","move"),$("loadBarContainer").fade("out"))},setScale:function(){var a=1e3*this.scale*this.wid/this.max_width,b="1m";a>1e3?(a/=100,b="1cm"):a>100&&(a/=10,b="10cm"),$("scale").set({styles:{width:a},html:b})},load:function(){new Request({method:"get",url:this.server,onComplete:function(a){var b=a||alert("No response from server "+this.server),c=b.split("Max-size");c[1]||alert("Unexpected response from server "+this.server);var d=c[1].split(" ");this.max_width=parseInt(d[0].substring(1,d[0].length)),this.max_height=parseInt(d[1]),c=b.split("Tile-size"),d=c[1].split(" "),this.tileSize[0]=parseInt(d[0].substring(1,d[0].length)),this.tileSize[1]=parseInt(d[1]),c=b.split("Resolution-number"),this.num_resolutions=parseInt(c[1].substring(1,c[1].length)),this.res=this.num_resolutions,this.createWindows()}.bind(this),onFailure:function(){alert("Unable to get image and tile sizes from server!")}}).send("FIF="+this.images[0].src+"&obj=IIP,1.0&obj=Max-size&obj=Tile-size&obj=Resolution-number")},reCenter:function(){this.rgn_x=(this.wid-this.rgn_w)/2,this.rgn_y=(this.hei-this.rgn_h)/2},positionZone:function(){var a=this.rgn_x/this.wid*this.min_x;a>this.min_x&&(a=this.min_x),0>a&&(a=0);var b=this.rgn_y/this.hei*this.min_y;b>this.min_y&&(b=this.min_y),0>b&&(b=0);var c=this.rgn_w/this.wid*this.min_x;a+c>this.min_x&&(c=this.min_x-a);var d=this.rgn_h/this.hei*this.min_y;d+b>this.min_y&&(d=this.min_y-b),c<this.min_x?this.xfit=0:this.xfit=1,d<this.min_y?this.yfit=0:this.yfit=1;var e=$("zone").offsetHeight-$("zone").clientHeight;$("zone").morph({left:a,top:b+10,width:c-e/2,height:d-e/2})}});
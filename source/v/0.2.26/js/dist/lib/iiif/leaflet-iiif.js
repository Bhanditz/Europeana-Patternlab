L.TileLayer.Iiif=L.TileLayer.extend({options:{continuousWorld:!0,tileSize:256,updateWhenIdle:!0,tileFormat:"jpg"},initialize:function(a,b){b=L.setOptions(this,b),this._infoDeferred=new $.Deferred,this._infoUrl=a,this._baseUrl=this._templateUrl(),this._getInfo()},getTileUrl:function(a){var b=this,c=a.x,d=a.y,e=b._map.getZoom(),f=Math.pow(2,b.maxNativeZoom-e),g=b.options.tileSize*f,h=c*g,i=d*g,j=Math.min(h+g,b.x),k=Math.min(i+g,b.y),l=j-h,m=k-i;return L.Util.template(this._baseUrl,L.extend({format:b.options.tileFormat,quality:b.quality,region:[h,i,l,m].join(","),rotation:0,size:b._iiifSizeParam(Math.ceil(l/f),Math.ceil(m/f))},this.options))},_iiifSizeParam:function(a,b){return a>=b?a+",":","+b},onAdd:function(a){var b=this;$.when(b._infoDeferred).done(function(){var c=b._getInitialZoom(a.getSize()),d=b._imageSizes[c],e=a.options.crs.pointToLatLng(L.point(0,d.y),c),f=a.options.crs.pointToLatLng(L.point(d.x,0),c),g=L.latLngBounds(e,f);a.fitBounds(g,!0),a._layersMaxZoom=b.maxZoom,L.TileLayer.prototype.onAdd.call(b,a),b.on("tileload",function(a,b){var c=a.tile.naturalHeight,d=a.tile.naturalWidth;(256!==c||256!==d)&&(a.tile.style.width=d+"px",a.tile.style.height=c+"px")})})},_getInfo:function(){var a=this;$.getJSON(a._infoUrl).done(function(b){a.y=b.height,a.x=b.width;var c,d,e,f,g,h,i=[],j=[];switch(c=b.profile instanceof Array?b.profile[0]:b.profile,!0){case/^http:\/\/library.stanford.edu\/iiif\/image-api\/1.1\/compliance.html.*$/.test(c):a.quality="native";break;case/^http:\/\/iiif.io\/api\/image\/2.*$/.test(c):a.quality="default"}ceilLog2=function(a){return Math.ceil(Math.log(a)/Math.LN2)},a.maxNativeZoom=Math.max(ceilLog2(a.x/a.options.tileSize),ceilLog2(a.y/a.options.tileSize)),a.options.maxZoom&&a.options.maxZoom>a.maxNativeZoom?a.maxZoom=a.options.maxZoom:a.maxZoom=a.maxNativeZoom;for(var k=0;k<=a.maxZoom;k++)d=Math.pow(2,a.maxNativeZoom-k),e=Math.ceil(a.x/d),f=Math.ceil(a.y/d),g=Math.ceil(e/a.options.tileSize),h=Math.ceil(f/a.options.tileSize),i.push([g,h]),j.push(L.point(e,f));a._tierSizes=i,a._imageSizes=j,a._infoDeferred.resolve()})},_infoToBaseUrl:function(){return this._infoUrl.replace("info.json","")},_templateUrl:function(){return this._infoToBaseUrl()+"{region}/{size}/{rotation}/{quality}.{format}"},_tileShouldBeLoaded:function(a){var b=this,c=b._map.getZoom(),d=b._tierSizes[c],e=a.x,f=a.y;return d?0>e||d[0]<=e||0>f||d[1]<=f?!1:!0:!1},_getInitialZoom:function(a){for(var b,c=this,d=.8,e=c.maxNativeZoom;e>=0;e--)if(b=this._imageSizes[e],b.x*d<a.x&&b.y*d<a.y)return e;return 2}}),L.tileLayer.iiif=function(a,b){return new L.TileLayer.Iiif(a,b)};
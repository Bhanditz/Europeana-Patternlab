define(["jquery","ga","purl"],function(a,b){function c(a){console.log(a)}b=window.fixGA(b);var d=a.url(),e=a(".search-results"),f=[],g=a(".icon-view-grid").closest("a"),h=a(".icon-view-list").closest("a"),i=a("#results_menu a"),j=function(){var b=a('<img style="object-fit: cover"/>'),c=window.getComputedStyle(b[0]);"undefined"!=typeof c.objectFit&&(c.objectFit||c["object-fit"]||Object.keys(c).indexOf("objectFit")>-1)||a(".search-list-item").each(function(b,c){$ob=a(c);var d=$ob.find("img").attr("src");$ob.find("img").css("visibility","hidden"),$ob.find(".inner").css("background-image","url("+d+")"),$ob.find(".inner").css("background-size","cover")})},k=function(){var b=e.find(".result-items h2:not(.js-ellipsis)"),c=[];b.css("overflow-y","auto"),b.each(function(){a(this).find("a")[0].offsetHeight>a(this).height()&&(a(this).addClass("js-ellipsis"),c.push(a(this)))}),b.css("overflow-y","hidden"),c.length>0&&require(["util_ellipsis"],function(b){for(var d=b.create(a(c)),e=0;e<d.length;e++)f.push(d[e])});var d=e.find(".search-list-item.missing-image .item-image .missing-image-text:not(.js-ellipsis)");d.size()>0&&(require(["util_ellipsis"],function(a){for(var b=a.create(d),c=0;c<b.length;c++)f.push(b[c])}),d.addClass("js-ellipsis"))},l=function(b,e,f){var g={};g[b]=e,e||delete g[b];var h=d.param();h[b]=e,e||delete h[b];var i=a.param(h);c("set state (replace): "+JSON.stringify(g)),f?window.history.replaceState(g,"","?"+i):window.history.pushState(g,"","?"+i)};window.onpopstate=function(a){if(a.state)c("state present, view = "+a.state.view),"grid"==a.state.view?u(!0):"list"==a.state.view&&v(!0),"undefined"!=typeof a.state.results&&m(a.state.results);else{if(-1!=navigator.userAgent.indexOf("Safari")&&-1==navigator.userAgent.indexOf("Chrome"))return;v()}};var m=function(b){var c=a(".result-items>li"),d=c.size();if(b>d){var e=a(".result-items>li").slice(0,b-d);e.each(function(b,c){a(c).parent().append(a(c).clone())}),a(".result-items>li").size()<b&&m(b)}else if(d>b){var f=a(".result-items>li").slice(b,d);f.remove()}n(b)},n=function(b){if(a(".result-actions a.dropdown-trigger").size()>0){var c=a(".result-actions a.dropdown-trigger").text(),d=c.match(/\d+/)[0];b=b?b:d,c=c.replace(d,""),a(".result-actions a.dropdown-trigger").html(c+'<span class="active">'+b+"</span>")}},o=function(){return"undefined"==typeof Storage?"list":localStorage.getItem("eu_portal_results_view")},p=function(a){"undefined"!=typeof Storage&&localStorage.setItem("eu_portal_results_view",a)},q=function(a){"undefined"!=typeof Storage&&localStorage.setItem("eu_portal_results_count",a)},r=function(){return"undefined"==typeof Storage?null:JSON.parse(localStorage.getItem("eu_portal_closed_tooltips"))},s=function(a){if("undefined"!=typeof Storage){var b=r();b||(b={tooltips:{}}),b.tooltips[a]=!0,localStorage.setItem("eu_portal_closed_tooltips",JSON.stringify(b))}},t=function(b){var c=function(c){var d=a.url(c.attr("href")),e=d.param("view");e!=b&&("undefined"==typeof e?"grid"==b&&c.attr("href",c.attr("href")+"&view="+b):c.attr("href",c.attr("href").replace("&view="+e,"&view="+b)))};a("#results_menu .dropdown-menu a, .results-list .pagination a, .searchbar a, .refine a").not(".tooltip-anchor").each(function(){c(a(this))})},u=function(b){a("body").addClass("display-grid"),g.addClass("is-active"),h.removeClass("is-active"),b&&p("grid");for(var c=0;c<f.length;c++)f[c].enable();t("grid"),j(),k()},v=function(b){a("body").removeClass("display-grid"),h.addClass("is-active"),g.removeClass("is-active"),b&&p("list"),t("list");for(var c=0;c<f.length;c++)f[c].disable()},w=function(){i.on("click",function(b){q(parseInt(a(b.target).text()))})},x=function(){g.on("click",function(a){a.preventDefault(),l("view","grid"),u(!0)}),h.on("click",function(a){a.preventDefault(),l("view","list"),v(!0)});var a=d.param("view");a?"grid"==a?u(!0):v(!0):"grid"==o()?(l("view","grid",!0),u()):v()},y=function(){a(".item-origin .external").on("click",function(){var c=a(this).attr("href");b("send",{hitType:"event",eventCategory:"Redirect",eventAction:c,eventLabel:"CTR List"})}),a(".refine .js-showhide-nested").on("click",function(){a(".refine .js-showhide-nested").data("ga-sent")||(b("send",{hitType:"event",eventCategory:"Licenses",eventAction:"Showing specific licenses to users",eventLabel:"Specific licenses"}),a(".refine .js-showhide-nested").data("ga-sent",!0))})},z=function(){var b=r();if(b)for(var c in b.tooltips)a("[data-tooltip-id='"+c+"']").closest(".tooltip-container").remove();a('.tooltip-container [data-role="remove"]').on("click",function(){var b=a(this).closest(".tooltip-container").find(".tooltip-anchor").data("tooltip-id");a(this).parent().hide(),s(b)}),a(".tooltip-container .tooltip-anchor").on("click",function(){a(this).next(".tooltip").show()})},A=function(){if(x(),w(),y(),z(),"undefined"!=typeof Storage){var b=a(".breadcrumbs").data("store-channel-label"),c=a(".breadcrumbs").data("store-channel-name"),d=a(".breadcrumbs").data("store-channel-url");sessionStorage.eu_portal_channel_label=b,sessionStorage.eu_portal_channel_name=c,sessionStorage.eu_portal_channel_url=d;var e=localStorage.getItem("eu_portal_results_count");e&&a(".search-multiterm").append('<input type="hidden" name="per_page" value="'+e+'" />')}};return{initPage:function(){A()}}});
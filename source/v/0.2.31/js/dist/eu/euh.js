var EuHierarchy=function(a,b,c){var d=this,e=!0,f=window.apiServerRoot?window.apiServerRoot:"",g=window.apiKey,b=b,h=2*b,i=b,j=h,k=1.4;d.treeCmp=a,d.timer=null,d.pageNodeId=!1,d.silentClick=!1,d.loadingAll=!1,d.loadedAll=!1,d.isLoading=!1,d.initialised=!1,d.container=d.treeCmp.closest(".hierarchy-container"),d.scrollDuration=0,d.scrollDurationDefault=2400,d.topPanel=c.find(".hierarchy-top-panel"),d.bottomPanel=c.find(".hierarchy-bottom-panel");var l=!0,m=500,n=function(){var a=this;return a.timerId=0,a.secondsElapsed=0,a.secondElapsed=function(){a.secondsElapsed++;var b="",c="";"undefined"!=typeof waitMessages&&$.each(waitMessages,function(d,e){a.secondsElapsed>e.time&&(b=e.msg),a.secondsElapsed+2>e.time&&(c=e.msg)});var d=$(".wait-msg").html();c!=d&&($(".wait-msg").removeClass("opaque"),$(".wait-msg").addClass("transparent")),b!=d&&($(".wait-msg").removeClass("transparent"),$(".wait-msg").addClass("opaque")),$(".wait-msg").html(b.length?b:"")},a.start=function(){a.secondsElapsed=0,$(".wait-msg").html("");try{window.clearInterval(a.timerId)}catch(b){}a.timerId=window.setInterval(a.secondElapsed,1e3)},a.stop=function(){p("STOP TIMER"),window.clearInterval(a.timerId)},{start:function(){a.start()},stop:function(){a.stop()}}},o=function(){$(".jstree-node.ul").prev(".jstree-node.ol").removeClass("ol").addClass("ol-ul")},p=function(a){e&&console.log(a)},q=function(a,b){var c=null,d=function(a){return a.replace(/\//g,"_").replace(/-/g,"_")},e=function(a,b,c,d,e,f,g){var h=b.def[0],i="undefined"==typeof d||0==d?"":"<span> ("+d+")<span>";return h="undefined"!=typeof hierarchyOriginalUrl&&a==hierarchyOriginalUrl?(f&&g?e+". ":"")+h+i:(f?e+". ":"")+'<a href="'+("undefined"!=typeof eu?eu.europeana.vars.homeUrlNS:"")+"/record"+a+'.html" onclick="var e = arguments[0] || window.event; followLink(e);">'+h+"</a>"+i,window.followLink=function(a){a.stopPropagation()},'<span class="icon'+(c?"  icon-"+c.toLowerCase():"")+'">'+h+" </span>"};if("self.json"===a.action)c={id:d(a.self.id),text:e(a.self.id,a.self.title,a.self.type,a.self.childrenCount,a.self.index,a.self.parent,a.self.relBefore),data:{id:a.self.id,index:a.self.index,hasChildren:a.self.hasChildren,parent:a.self.parent,relBefore:a.self.relBefore}},c.data.hasChildren&&(c.data.childrenCount=a.self.childrenCount);else{var f=b?b.self.id:null;c={id:d(a.id),text:e(a.id,a.title,a.type,a.childrenCount,a.index,f,a.relBefore),data:{id:a.id,index:a.index,hasChildren:a.hasChildren,parent:f,relBefore:a.relBefore}},c.data.hasChildren&&(c.data.childrenCount=a.childrenCount)}return c},r=function(a,b){p("loadData"+a),$.getJSON(a,null,function(a){b(a)}).fail(function(b){p("failed to load data ("+JSON.stringify(b)+") from url: "+a)})},s=function(){return d.treeCmp.find(">ul>li:first-child")},t=function(a){var b=$(".loadPoint");if(!b.length)return!1;b=b.attr("id");var c=0,e=0,f=function(g,h){return h=h?h:0,$.each(g.children,function(g,i){h++;var j=d.treeCmp.jstree("get_node",i);j.id==b&&(c=h),j==a&&(e=h),j.state.opened&&(h=f(j,h))}),h};return f(d.treeCmp.jstree("get_node",s().attr("id"))),[c,e]},u=function(a,b){if(!a.data||!a.data.hasChildren||a.children&&a.children.length)b&&b();else{var c=f+a.data.id+"/children.json?wskey="+g+"&limit=1";r(c,function(c){var e=c.children[0];childUrl=f+e.id+"/self.json?wskey="+g,r(childUrl,function(c){var e=d.treeCmp.jstree("create_node",a,q(c),"first",!1,!0),f=d.treeCmp.jstree("get_node",e);b(f)})})}},v=function(a,b,c,e,h){if(null==a.parent||"string"!=typeof a.parent.toLowerCase())return p("node.parent = null: node is "+a.id+" (returning)"),void(h&&h());if(!b&&e){for(var i=a;i.children.length&&i.state.opened;)i=d.treeCmp.jstree("get_node",i.children[0]);for(var j=function(a){var b=d.treeCmp.jstree("get_node",a.parent);if(!b.data)return!1;var c=b.children.length,e=b.data.childrenCount;return c==e};j(i);)i=d.treeCmp.jstree("get_node",i.parent);a=i}var k=d.treeCmp.jstree("get_node",a.parent);if(a=d.treeCmp.jstree("get_node",b?k.children[0]:k.children[k.children.length-1]),"string"==(typeof a.parent).toLowerCase()){var k=d.treeCmp.jstree("get_node",a.parent);if(b){var l=0;if($.each(k.children,function(b,c){c==a.id&&(l=b)}),l>0){var m=d.treeCmp.jstree("get_node",k.children[l-1]);if(d.treeCmp.jstree("is_disabled",m)){var n=m.children[m.children.length-1];a=d.treeCmp.jstree("get_node",n),k=m}}}var o=function(){if(c>0){var e=d.treeCmp.jstree("get_node",a.parent,!1);"object"==typeof e.data?v(e,b,c,!1,h):(p("no more data"),h&&h())}else p("EXIT LOAD (leftToLoad hit zero)"),h&&h()};if(a.data.parent){var s=f+a.data.id+"/"+(b?"preceding":"following")+"-siblings.json?wskey="+g+"&limit="+c;r(s,function(e){var f=e;e=e[(b?"preceding":"following")+"-siblings"],p(" - loaded "+typeof e),e&&e.length?$.each(e,function(g,i){var j=d.treeCmp.jstree("create_node",k,q(i,f),b?"first":"last",!1,!0),l=d.treeCmp.jstree("get_node",j);u(l,function(){g+1==e.length&&(c-=e.length,c>0?v(a,b,c,!0,h):h&&h())})}):b?(d.treeCmp.jstree("is_disabled",k)&&(d.treeCmp.jstree("enable_node",k),c--),c>0?v(k,b,c,!0,h):h&&(p("recurse point three EXIT - (going backwards, nothing left to load)"),h())):o()})}else o()}else p("no parent")},w=function(){d.container.prev(".ajax-overlay").length||d.container.before('<div class="ajax-overlay"><span class="wait-msg"></span></div>'),d.container.prev(".ajax-overlay").show(),$("<style></style>").appendTo($(document.body)).remove()},x=function(){d.initialised&&(d.container.prev(".ajax-overlay").hide(),$("<style></style>").appendTo($(document.body)).remove())},y=function(a){var b=window.location.href.indexOf("?")?window.location.href.split("?")[0]:window.location.href;window.location.href=b+"?"+$(a).attr("href")},z=function(){d.topPanel.find(".top-arrows").remove();var a=$('<div class="top-arrows"></div>').appendTo(d.topPanel),b=E(),c=b[0],e=1,f=c.data.index,g=$("#"+c.id).hasClass("ul"),h=!1;for("#"!=c.id&&$("#"+c.id).hasClass("jstree-open")&&(h=!0),$("#"+c.id).hasClass("jstree-last")&&(h=!0);c.parent;)if(f=c.data.index,c=d.treeCmp.jstree("get_node",c.parent),"#"!=c.id){var i=c.data.childrenCount;if($("#"+c.id+" > .jstree-children").length||$("#"+c.id).hasClass("jstree-last")){e++;var j=f==i?"arrow-spacer":g?"arrow top-ul":"arrow top";h&&(j=g?"arrow top-ul":"arrow top",h=!1),a.append('<div title="'+g+'" class="'+j+'" style="right:'+e+'em">'),a.css("width",e+"em"),$(".hierarchy-prev").css("margin-left",e+2+"em")}g=$("#"+c.id).hasClass("ul")}A(b)},A=function(a){d.bottomPanel.find(".bottom-arrows").remove();var b=function(a){for(var b=$("#"+a.id).next();0==b.length;){var c=$("#"+a.id).parent().closest("li");if(0==c.length)break;a=c,b=c.next()}return b},c=$('<div class="bottom-arrows"></div>').prependTo(d.bottomPanel),e=a[1],f=2,g=b(e).hasClass("ul");if("#"!=e.id&&$("#"+e.id).hasClass("jstree-open")){var h="arrow bottom",i='<div title="'+g+" "+$("#"+a[1].id).hasClass("ul")+'" class="'+h+'" style="right:'+f+'em">';f++,c.append(i),c.css("width",f+"em")}for(;e.parent;){var j=e.data.index;if(e=d.treeCmp.jstree("get_node",e.parent),"#"!=e.id){var k=e.data.hasChildren?e.data.childrenCount:0;if($("#"+e.id+" > .jstree-children").length){f++;var h=j==k?"arrow-spacer":g?"arrow bottom-ul":"arrow bottom",i='<div title="'+g+'" class="'+h+'" style="right:'+f+'em">';c.append(i),c.css("width",f+"em"),$(".hierarchy-next").css("margin-left",f+1+"em")}g=b(e).hasClass("ul")}}},B=function(){z();var a=d.container.scrollTop();d.container.scrollTop()>1?($(".hierarchy-prev").addClass("show"),$(".hierarchy-top-panel").removeClass("top")):($(".hierarchy-prev").removeClass("show"),$(".hierarchy-top-panel").addClass("top"));var b=d.container.height(),c=d.treeCmp.height();c-a>b?$(".hierarchy-next").addClass("show"):$(".hierarchy-next").removeClass("show")},C=function(a,b){return o(),"undefined"==typeof a?void p("doScrollTo error - undefined @el"):(d.container.css("overflow","auto"),d.container.scrollTo(a,d.scrollDuration,{axis:"y",onAfter:function(){return b?(l&&d.container.css("overflow","hidden"),void b()):void 0}}),void(l&&d.container.css("overflow","hidden")))},D=function(a,b,c,e){if(!d.isLoading){d.isLoading=!0,d.loadingAll||d.timer.start(),$(".top-arrows").add($(".bottom-arrows")).addClass("transparent");var f=$(".jstree-container-ul .jstree-disabled").length,g=(parseInt(d.container.scrollTop()),E()),i=c?g[0]==c||c.state.disabled:!1,j=g[0].id;w(),v(a,b,h,!0,function(){var g=d.container.height(),h=$(".jstree-container-ul .jstree-disabled").length,k=function(){var a=h!=f,c=E()[2].id,e=$("#"+c+">a");return b&&a?(d.silentClick=!0,e.click(),d.scrollDuration=0,C("#"+c,function(){d.scrollDuration=d.scrollDurationDefault,x(),e.focus()}),!0):void(b&&e.focus())};if(c)d.scrollDuration=0,C("#"+j),d.scrollDuration=d.scrollDurationDefault,i?k():$("#"+a.id+">a").focus(),x(),e&&(d.isLoading=!1,d.loadingAll||d.timer.stop(),e());else{var l=function(){var c=d.container.scrollTop(),f=c,h=E();a==h[0]?(b?f-=g:f+=g,f=Math.max(0,f),!b&&d.container.height()<f&&(f="#"+h[1].id)):p("ERROR CODE 1\n\nIf you see this please record the what steps were needed to produce this error and what browser was used, and let Andy know about it\n\ninitiatingNode != visibleNodes[0]\n\ninitiator was "+a.id),x(),C(f,function(){d.scrollDuration=0,setTimeout(function(){C("#"+E()[0].id,function(){d.scrollDuration=d.scrollDurationDefault,B(),d.loadingAll||d.timer.stop(),d.isLoading=!1,e&&e()})},1)})};d.scrollDuration=0,C("#"+j),d.scrollDuration=d.scrollDurationDefault,l()}})}};$(".load-more").click(function(){alert("no handler")}),$(".view-next").click(function(){alert("no handler")}),$(".hierarchy-prev>a").click(function(){D(E()[0],!0,!1,function(){})}),$(".hierarchy-next>a").click(function(){D(E()[0],!1,!1,function(){})});var E=function(){var a=$(".ajax-overlay").is(":visible");a&&x();var b=null,c=null,e=null,f=d.bottomPanel[0].getBoundingClientRect().top,g=d.topPanel[0].getBoundingClientRect().bottom;return $(".jstree-anchor").not(".jstree-disabled").each(function(a,d){var e=d.getBoundingClientRect().top+5;return!b&&e>=g&&(b=d),e>f?!1:void(c=d)}),c=$(c).closest("li.jstree-node"),b=$(b).closest("li.jstree-node"),e=b.prevAll("li.jstree-node:first"),e.length||(e=b.closest("li.jstree-node")),e.length||(e=b),a&&w(),[d.treeCmp.jstree("get_node",b.attr("id")),d.treeCmp.jstree("get_node",c.attr("id")),d.treeCmp.jstree("get_node",e.attr("id"))]},F=function(){d.initialised=!0,d.container.removeClass("uninitialised"),d.topPanel.removeClass("uninitialised"),h=i},G=function(a,i,l){e=l,d.timer=new n;var m=function(){if(!d.loadedAll){var a=navigator.userAgent.match(/Trident/)||navigator.userAgent.match(/MSIE/);a&&d.container.css("margin-left","1em"),navigator.userAgent.match(/Chrome/i)||navigator.userAgent.match(/Opera/i)||navigator.userAgent.match(/Safari/i)?d.container.css({height:b*k-.4+"em","max-height":b*k-.4+"em"}):d.container.css({height:b*k+"em","max-height":b*k+"em"}),d.treeCmp.css("padding-bottom",b*k+"em");var c=d.container.outerHeight(!0);d.container.css({height:c+"px","max-height":c+"px"})}},y=document.documentElement.clientWidth/window.innerWidth;$(window).resize(function(){var a=document.documentElement.clientWidth/window.innerWidth;y!=a&&(y=a,m(),C("#"+E()[0].id,function(){B()}))}),m();var z=function(a){$(".loadPoint").removeClass("loadPoint"),$("#"+a).addClass("loadPoint")},A=function(a,b){w(),d.isLoading=!0,d.loadingAll||d.timer.start();var c=function(){C($("#"+a.id),function(){B(),z(a.id),$("#"+a.id+">a").focus(),b&&b(),d.isLoading=!1,d.loadingAll||d.timer.stop(),x()})};j>0?v(a,!1,j,!0,function(){c()}):c()};d.treeCmp.bind("select_node.jstree",function(a,b){e&&($(".debug-area").html(JSON.stringify(b.node,null,2)),d.silentClick||d.loadedAll||A(b.node)),d.silentClick=!1}),d.treeCmp.bind("create_node.jstree",function(a,b){node=d.treeCmp.jstree("get_node",b.node.id),node.data.relBefore?node.li_attr["class"]="ol":(o(),node.li_attr["class"]="ul",$("#"+node.id).addClass("ul"))}),d.treeCmp.bind("loaded.jstree",function(a,b){setTimeout(function(){var a=d.treeCmp.jstree("get_node",d.pageNodeId);A(a,function(){setTimeout(function(){var a=d.treeCmp.jstree("get_node",d.pageNodeId);u(a,function(){d.treeCmp.jstree("disable_node",a.parent),z(d.pageNodeId),d.scrollDuration=d.scrollDurationDefault;var b=d.treeCmp.jstree("get_node",s().attr("id"));c.find(".hierarchy-title").html(s().find("span").html()),d.pageNodeId==b.id?(c.find(".hierarchy-title a").wrapInner("<span/>"),c.find(".hierarchy-title a span").unwrap(),d.treeCmp.jstree("open_node",a)):(c.find(".hierarchy-title").contents().filter(function(){return 3==this.nodeType}).remove(),$("#"+d.pageNodeId+">a").focus(),F(),x(),$("#"+d.pageNodeId+">a").focus(),d.isLoading=!1,d.timer.stop(),setTimeout(function(){console.log("scroll to "+d.pageNodeId+" ("+$("#"+d.pageNodeId).length+")"),C("#"+d.pageNodeId)},800))})},1)})},1)}),d.treeCmp.bind("keydown.jstree",function(a){if(!(d.loadingAll||d.isLoading||40!=a.which&&38!=a.which)){if(a.ctrlKey||a.shiftKey){var b=function(){$("#"+E()[0].id+">a").focus()};return 38==a.which&&$(".hierarchy-prev").is(":visible")&&D(E()[0],!0,!1,function(){B(),b()}),void(40==a.which&&$(".hierarchy-next").is(":visible")&&D(E()[0],!1,!1,function(){B(),b()}))}var c,e=d.treeCmp.find(".jstree-hovered"),f=d.treeCmp.jstree("get_node",e.parent()),g=!1,i=38==a.which;if(e.hasClass("jstree-disabled"))g=!0,c=d.treeCmp.jstree("get_node",$(".loadPoint").attr("id"));else{var j=t(f);j=j?i?j.reverse():j:!1,(!j||j[0]>j[1]||j[1]-j[0]>h/2)&&(g=!0,c=f)}if(g){$(".jstree-container-ul .jstree-disabled").length;D(c,i,f,function(){z(c.id),B()})}else d.scrollDuration=0,C("#"+E()[0].id,function(){d.scrollDuration=d.scrollDurationDefault,B()})}}),d.treeCmp.on("open_node.jstree",function(a,b){if(d.loadingAll||d.isLoading)return void p("return because loading - open_node");d.isLoading=!0,d.timer.start(),w();var c=b.node,e=d.treeCmp.jstree("get_node",c.children[0]);u(e,function(a){v(e,!1,h,!0,function(){d.initialised||F(),z(c.id),x(),$("#"+c.id+">a").focus(),B(),o(),d.isLoading=!1,d.timer.stop(),d.initialised||F()})})}),d.treeCmp.bind("close_node.jstree",function(a,b){d.loadingAll||(p("closed "+b.node.text),w(),v(b.node,!1,h,!0,function(){z(b.node.id),x(),o(),$("#"+b.node.id+">a").focus(),setTimeout(function(){B()},500)}))});var G=function(a,b,e){if(!a)return p("NO URL - exit"),void e(b);var h=function(a){var h=q(a);b?(h.state={opened:!0,disabled:!0},h.children=$.isArray(b)?b:[b],b=h):(b=h,d.pageNodeId=b.id);var i=!1;if($.isArray(h)&&h.length?(p("ERROR CODE 2"),i=b[0].data):i=b,i&&i.data&&i.data.parent&&"undefined"!=typeof i.data.index){var j=f+i.data.parent+"/self.json?wskey="+g;G(j,b,e)}else c.find(".hierarchy-title").html(b.text.substr(b.text.indexOf(". ")+2,b.text.length)),c.find(".hierarchy-title span").removeAttr("class"),c.find(".hierarchy-title a").removeAttr("onclick"),e(b)};"object"==typeof a?h(a):r(a,h)};if(i){var H=a,I=null,J=null;H.ancestors?($.each(H.ancestors.reverse(),function(a,b){pData=q(b,H),J?(J.state={opened:!0,disabled:!0},J.children=[pData],J=J.children[0]):(J=pData,I=J),J.data.childrenCount&&0!=J.data.childrenCount||alert("Sorry to alert you, but fix the data!\n\nAncestors are expected to have a children count greater than zero.\n\nThere is no number after the title in this hierarchy because of this missing data\n(and non-flat hierarchies will break):\n\n"+JSON.stringify(J,null,4))}),J.children=[],J.state={opened:!0},J.children.push(q(H.self,{self:{id:J.data.id}})),d.pageNodeId=J.children[J.children.length-1].id):(J=q(H.self),d.pageNodeId=J.id,I=J),H["preceding-siblings"]&&$.each(H["preceding-siblings"],function(a,b){}),H["following-siblings"]&&$.each(H["following-siblings"],function(a,b){});var K=(d.treeCmp.jstree({core:{data:I,check_callback:!0},plugins:["themes","json_data","ui"]}),function(a){a.data.relBefore?a.li_attr["class"]="ol":(a.li_attr["class"]="ul",$("#"+a.id).addClass("ul"));for(var b=0;b<a.children.length;b++)K(d.treeCmp.jstree("get_node",a.children[b]))});K(d.treeCmp.jstree("get_node",s().attr("id"))),setTimeout(function(){o()},1e3)}else G(a,!1,function(a){J=a,p("Initialise tree with model:\n\n"+JSON.stringify(J,null,2));d.treeCmp.jstree({core:{data:J,check_callback:!0},plugins:["themes","json_data","ui"]})})};return{init:function(a,b,c){G(a,b,c)},nodeLinkClick:function(a){y(a)},getContainer:function(){return d.container},getVisibleNodes:function(){return E()},getLocked:function(){return d.locked},getIsLoading:function(){return d.isLoading},setLocked:function(a){d.locked=a},brokenArrows:function(){z()},setDefaultDelay:function(a){m=a},startTimer:function(a){w(),d.timer.start()},stopTimer:function(a){x(),d.timer.stop()},scrollTop:function(a){a?d.container.scrollTop(a):alert("scroll top is: "+d.container.scrollTop())},getTree:function(){return d.treeCmp},getInitialised:function(){return d.initialised},getTreeData:function(){var a=d.treeCmp.jstree("get_node","0");return JSON.stringify(a)},addTransitionClasses:function(){o()}}};
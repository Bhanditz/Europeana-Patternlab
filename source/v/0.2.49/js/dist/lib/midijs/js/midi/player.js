"undefined"==typeof MIDI&&(MIDI={}),"undefined"==typeof MIDI.Player&&(MIDI.Player={}),function(){"use strict";var a=MIDI.Player;a.currentTime=0,a.endTime=0,a.restart=0,a.playing=!1,a.timeWarp=1,a.startDelay=0,a.BPM=120,a.start=a.resume=function(b){a.currentTime<-1&&(a.currentTime=-1),l(a.currentTime,null,b)},a.pause=function(){var b=a.restart;m(),a.restart=b},a.stop=function(){m(),a.restart=0,a.currentTime=0},a.addListener=function(a){g=a},a.removeListener=function(){g=void 0},a.clearAnimation=function(){a.animationFrameId&&cancelAnimationFrame(a.animationFrameId)},a.setAnimation=function(b){var c=0,d=0,e=0;a.clearAnimation();var g=function(){if(a.animationFrameId=requestAnimationFrame(g),0!==a.endTime){a.playing?(c=e===a.currentTime?d-Date.now():0,c=0===a.currentTime?0:a.currentTime-c,e!==a.currentTime&&(d=Date.now(),e=a.currentTime)):c=a.currentTime;var h=a.endTime,i=c/1e3,j=i/60,k=i-60*j,l=60*j+k,m=h/1e3;-1>m-l||b({now:l,end:m,events:f})}};requestAnimationFrame(g)},a.loadMidiFile=function(b,c,d){try{a.replayer=new Replayer(MidiFile(a.currentData),a.timeWarp,null,a.BPM),a.data=a.replayer.getData(),a.endTime=j(),MIDI.loadPlugin({onsuccess:b,onprogress:c,onerror:d})}catch(e){d&&d(e)}},a.loadFile=function(b,c,d,e){if(a.stop(),-1!==b.indexOf("base64,")){var f=window.atob(b.split(",")[1]);a.currentData=f,a.loadMidiFile(c,d,e)}else{var g=new XMLHttpRequest;g.open("GET",b),g.overrideMimeType("text/plain; charset=x-user-defined"),g.onreadystatechange=function(){if(4===this.readyState)if(200===this.status){for(var b=this.responseText||"",f=[],g=b.length,h=String.fromCharCode,i=0;g>i;i++)f[i]=h(255&b.charCodeAt(i));var j=f.join("");a.currentData=j,a.loadMidiFile(c,d,e)}else e&&e("Unable to load MIDI file")},g.send()}},a.getFileInstruments=function(){for(var b={},c={},d=0;d<a.data.length;d++){var e=a.data[d][0].event;if("channel"===e.type){var f=e.channel;switch(e.subtype){case"controller":break;case"programChange":c[f]=e.programNumber;break;case"noteOn":var g=c[f],h=MIDI.GM.byId[isFinite(g)?g:f];b[h.id]=!0}}}var i=[];for(var j in b)i.push(j);return i};var b,c,d=[],e=0,f={},g=void 0,h=function(c,e,h,i,j,k,m){return setTimeout(function(){var i={channel:c,note:e,now:h,end:a.endTime,message:j,velocity:k};128===j?delete f[e]:f[e]=i,g&&g(i),a.currentTime=h,d.shift(),d.length<1e3?l(b,!0):a.currentTime===b&&b<a.endTime&&l(b,!0)},h-i)},i=function(){return"webaudio"===MIDI.api?MIDI.WebAudio.getContext():(a.ctx={currentTime:0},a.ctx)},j=function(){for(var b=a.data,c=b.length,d=.5,e=0;c>e;e++)d+=b[e][1];return d},k=function(){return window.performance&&window.performance.now?window.performance.now():Date.now()},l=function(f,g,l){if(a.replayer){g||("undefined"==typeof f&&(f=a.restart),a.playing&&m(),a.playing=!0,a.data=a.replayer.getData(),a.endTime=j());var n,o=0,p=0,q=a.data,r=i(),s=q.length;b=.5;var t=(d[0]&&d[0].interval||0,f-a.currentTime);if("webaudio"!==MIDI.api){var u=k();c=c||u,r.currentTime=(u-c)/1e3}e=r.currentTime;for(var v=0;s>v&&100>p;v++){var w=q[v];if((b+=w[1])<=f)o=b;else{f=b-o;var x=w[0].event;if("channel"===x.type){var y=x.channel,z=MIDI.channels[y],A=r.currentTime+(f+t+a.startDelay)/1e3,B=b-o+a.startDelay;switch(x.subtype){case"controller":MIDI.setController(y,x.controllerType,x.value,A);break;case"programChange":MIDI.programChange(y,x.programNumber,A);break;case"pitchBend":MIDI.pitchBend(y,x.value,A);break;case"noteOn":if(z.mute)break;n=x.noteNumber-(a.MIDIOffset||0),d.push({event:x,time:B,source:MIDI.noteOn(y,x.noteNumber,x.velocity,A),interval:h(y,n,b+a.startDelay,o-t,144,x.velocity)}),p++;break;case"noteOff":if(z.mute)break;n=x.noteNumber-(a.MIDIOffset||0),d.push({event:x,time:B,source:MIDI.noteOff(y,x.noteNumber,A),interval:h(y,n,b,o-t,128,0)})}}}}l&&l(d)}},m=function(){var b=i();for(a.playing=!1,a.restart+=1e3*(b.currentTime-e);d.length;){var c=d.pop();window.clearInterval(c.interval),c.source&&("number"==typeof c.source?window.clearTimeout(c.source):c.source.disconnect(0))}for(var h in f){var c=f[h];144===f[h].message&&g&&g({channel:c.channel,note:c.note,now:c.now,end:c.end,message:128,velocity:c.velocity})}f={}}}();
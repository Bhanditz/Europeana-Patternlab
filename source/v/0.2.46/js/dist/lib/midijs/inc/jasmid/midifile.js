function MidiFile(a){function b(a){var b=a.read(4),c=a.readInt32();return{id:b,length:c,data:a.read(c)}}function c(a){var b={};b.deltaTime=a.readVarInt();var c=a.readInt8();if(240==(240&c)){if(255==c){b.type="meta";var e=a.readInt8(),f=a.readVarInt();switch(e){case 0:if(b.subtype="sequenceNumber",2!=f)throw"Expected length for sequenceNumber event is 2, got "+f;return b.number=a.readInt16(),b;case 1:return b.subtype="text",b.text=a.read(f),b;case 2:return b.subtype="copyrightNotice",b.text=a.read(f),b;case 3:return b.subtype="trackName",b.text=a.read(f),b;case 4:return b.subtype="instrumentName",b.text=a.read(f),b;case 5:return b.subtype="lyrics",b.text=a.read(f),b;case 6:return b.subtype="marker",b.text=a.read(f),b;case 7:return b.subtype="cuePoint",b.text=a.read(f),b;case 32:if(b.subtype="midiChannelPrefix",1!=f)throw"Expected length for midiChannelPrefix event is 1, got "+f;return b.channel=a.readInt8(),b;case 47:if(b.subtype="endOfTrack",0!=f)throw"Expected length for endOfTrack event is 0, got "+f;return b;case 81:if(b.subtype="setTempo",3!=f)throw"Expected length for setTempo event is 3, got "+f;return b.microsecondsPerBeat=(a.readInt8()<<16)+(a.readInt8()<<8)+a.readInt8(),b;case 84:if(b.subtype="smpteOffset",5!=f)throw"Expected length for smpteOffset event is 5, got "+f;var g=a.readInt8();return b.frameRate={0:24,32:25,64:29,96:30}[96&g],b.hour=31&g,b.min=a.readInt8(),b.sec=a.readInt8(),b.frame=a.readInt8(),b.subframe=a.readInt8(),b;case 88:if(b.subtype="timeSignature",4!=f)throw"Expected length for timeSignature event is 4, got "+f;return b.numerator=a.readInt8(),b.denominator=Math.pow(2,a.readInt8()),b.metronome=a.readInt8(),b.thirtyseconds=a.readInt8(),b;case 89:if(b.subtype="keySignature",2!=f)throw"Expected length for keySignature event is 2, got "+f;return b.key=a.readInt8(!0),b.scale=a.readInt8(),b;case 127:return b.subtype="sequencerSpecific",b.data=a.read(f),b;default:return b.subtype="unknown",b.data=a.read(f),b}return b.data=a.read(f),b}if(240==c){b.type="sysEx";var f=a.readVarInt();return b.data=a.read(f),b}if(247==c){b.type="dividedSysEx";var f=a.readVarInt();return b.data=a.read(f),b}throw"Unrecognised MIDI event type byte: "+c}var h;0==(128&c)?(h=c,c=d):(h=a.readInt8(),d=c);var i=c>>4;switch(b.channel=15&c,b.type="channel",i){case 8:return b.subtype="noteOff",b.noteNumber=h,b.velocity=a.readInt8(),b;case 9:return b.noteNumber=h,b.velocity=a.readInt8(),0==b.velocity?b.subtype="noteOff":b.subtype="noteOn",b;case 10:return b.subtype="noteAftertouch",b.noteNumber=h,b.amount=a.readInt8(),b;case 11:return b.subtype="controller",b.controllerType=h,b.value=a.readInt8(),b;case 12:return b.subtype="programChange",b.programNumber=h,b;case 13:return b.subtype="channelAftertouch",b.amount=h,b;case 14:return b.subtype="pitchBend",b.value=h+(a.readInt8()<<7),b;default:throw"Unrecognised MIDI event type: "+i}}var d;stream=Stream(a);var e=b(stream);if("MThd"!=e.id||6!=e.length)throw"Bad .mid file - header not found";var f=Stream(e.data),g=f.readInt16(),h=f.readInt16(),i=f.readInt16();if(32768&i)throw"Expressing time division in SMTPE frames is not supported yet";ticksPerBeat=i;for(var j={formatType:g,trackCount:h,ticksPerBeat:ticksPerBeat},k=[],l=0;l<j.trackCount;l++){k[l]=[];var m=b(stream);if("MTrk"!=m.id)throw"Unexpected chunk - expected MTrk, got "+m.id;for(var n=Stream(m.data);!n.eof();){var o=c(n);k[l].push(o)}}return{header:j,tracks:k}}